--
-- PSQ_COUNTRY_REGIONS
--
create materialized view PSQ_COUNTRY_REGIONS as
with Q_LOCR as
 (select LOCR.LOC_ID_TO, LOCR.LOCRT_CODE,
    LOC.ID as LOC_ID, LOC.LOCT_CODE, LOC.ITM_ID, LOC.NAME,
    LOCA.NUM_VALUE as ORDER_SEQ
  from LOCATION_RELATIONSHIPS LOCR
  inner join LOCATIONS LOC
    on LOC.ID = LOCR.LOC_ID_FROM
  left outer join LOCATION_ATTRIBUTES LOCA
    on LOCA.LOC_ID = LOC.ID
    and LOCA.LOCAT_CODE = 'DISPLAYSEQ')
select OGN.ID as COU_ID,
  LOCR1.LOC_ID as UNSD_GSR_LOC_ID,
  LOCR1.ITM_ID as UNSD_GSR_ITM_ID,
  LOCR1.ORDER_SEQ as UNSD_GSR_ORDER_SEQ,
  nvl(LOCR3.LOC_ID, LOCR2.LOC_ID) as UNSD_MGR_LOC_ID,
  nvl(LOCR3.ITM_ID, LOCR2.ITM_ID) as UNSD_MGR_ITM_ID,
  nvl(LOCR3.ORDER_SEQ, LOCR2.ORDER_SEQ) as UNSD_MGR_ORDER_SEQ,
  LOCR4.LOC_ID as UNHCR_ROP_LOC_ID,
  LOCR4.ITM_ID as UNHCR_ROP_ITM_ID,
  LOCR4.ORDER_SEQ as UNHCR_ROP_ORDER_SEQ,
  nvl(LOCR5.LOC_ID, LOCR4.LOC_ID) as UNHCR_BUR_LOC_ID,
  nvl(LOCR5.ITM_ID, LOCR4.ITM_ID) as UNHCR_BUR_ITM_ID,
  nvl(LOCR5.ORDER_SEQ, LOCR4.ORDER_SEQ) as UNHCR_BUR_ORDER_SEQ
from ORIGINS OGN
left outer join Q_LOCR LOCR1
  on LOCR1.LOC_ID_TO = OGN.ID
  and LOCR1.LOCRT_CODE = 'UNSD'
  and LOCR1.LOCT_CODE = 'UNSD-GSR'
left outer join Q_LOCR LOCR2
  on LOCR2.LOC_ID_TO = LOCR1.LOC_ID
  and LOCR2.LOCRT_CODE = 'UNSD'
  and LOCR2.LOCT_CODE in ('UNSD-GSR','UNSD-MGR')
left outer join Q_LOCR LOCR3
  on LOCR3.LOC_ID_TO = LOCR2.LOC_ID
  and LOCR3.LOCRT_CODE = 'UNSD'
  and LOCR3.LOCT_CODE = 'UNSD-MGR'
left outer join Q_LOCR LOCR4
  on LOCR4.LOC_ID_TO = OGN.ID
  and LOCR4.LOCRT_CODE = 'HCRRESP'
  and LOCR4.LOCT_CODE in ('HCR-ROP', 'HCR-BUR')
left outer join Q_LOCR LOCR5
  on LOCR5.LOC_ID_TO = LOCR4.LOC_ID
  and LOCR5.LOCRT_CODE = 'HCRRESP'
  and LOCR5.LOCT_CODE = 'HCR-BUR';
