--
-- ASR_RSD - Individual asylum applications and refugee status determination
--
create or replace view ASR_RSD as
with Q_ASR_RSD as
 (select ASR_YEAR, LOC_ID_ASYLUM_COUNTRY, LOC_ID_ORIGIN_COUNTRY, DIM_ID1, DIM_ID2, STG_ID_PRIMARY,
    ASYPOP_START_VALUE, ASYPOP_START_STC_ID, ASYPOP_START_VERSION_NBR, ASYPOP_START_ITM_ID,
    ASYPOP_AH_START_VALUE, ASYPOP_AH_START_STC_ID, ASYPOP_AH_START_VERSION_NBR,
    ASYPOP_AH_START_ITM_ID,
    ASYAPP_VALUE, ASYAPP_STC_ID, ASYAPP_VERSION_NBR, ASYAPP_ITM_ID,
    ASYREC_CV_VALUE, ASYREC_CV_STC_ID, ASYREC_CV_VERSION_NBR, ASYREC_CV_ITM_ID,
    ASYREC_CP_VALUE, ASYREC_CP_STC_ID, ASYREC_CP_VERSION_NBR, ASYREC_CP_ITM_ID,
    ASYREJ_VALUE, ASYREJ_STC_ID, ASYREJ_VERSION_NBR, ASYREJ_ITM_ID,
    ASYOTHCL_VALUE, ASYOTHCL_STC_ID, ASYOTHCL_VERSION_NBR, ASYOTHCL_ITM_ID,
    ASYPOP_END_VALUE, ASYPOP_END_STC_ID, ASYPOP_END_VERSION_NBR, ASYPOP_END_ITM_ID,
    ASYPOP_AH_END_VALUE, ASYPOP_AH_END_STC_ID, ASYPOP_AH_END_VERSION_NBR, ASYPOP_AH_END_ITM_ID
  from
   (select to_char(extract(year from STC.START_DATE)) as ASR_YEAR,
      STC.LOC_ID_ASYLUM_COUNTRY, STC.LOC_ID_ORIGIN_COUNTRY,
      STC.DIM_ID1, STC.DIM_ID2, STC.STG_ID_PRIMARY,
      replace(STC.STCT_CODE, '-', '_') ||
        case
          when extract(day from STC.END_DATE) = 2 then '_START'
          when extract(day from STC.START_DATE) = 31 then '_END'
        end as COLUMN_NAME,
      STC.VALUE,
      STC.ID as STC_ID,
      STC.VERSION_NBR,
      STC.ITM_ID
    from T_STATISTIC_TYPES_IN_GROUPS STTIG
    inner join T_STATISTICS STC
      on STC.STCT_CODE = STTIG.STCT_CODE
    where STTIG.STTG_CODE = 'RSD')
  pivot
   (sum(VALUE) as VALUE, max(STC_ID) as STC_ID, max(VERSION_NBR) as VERSION_NBR,
      max(ITM_ID) as ITM_ID
    for COLUMN_NAME
    in ('ASYPOP_START' as ASYPOP_START,
        'ASYPOP_AH_START' as ASYPOP_AH_START,
        'ASYAPP' as ASYAPP,
        'ASYREC_CV' as ASYREC_CV,
        'ASYREC_CP' as ASYREC_CP,
        'ASYREJ' as ASYREJ,
        'ASYOTHCL' as ASYOTHCL,
        'ASYPOP_END' as ASYPOP_END,
        'ASYPOP_AH_END' as ASYPOP_AH_END))),
--
Q_DIMENSION_VALUES as
 (select ID, DESCRIPTION, CODE
  from
   (select DIM.ID, TXT.TEXT DESCRIPTION, DIM.CODE,
      row_number() over
       (partition by DIM.ID
        order by LANG.ACTIVE_FLAG desc, nvl(ULP.PREF_SEQ, LANG.DISPLAY_SEQ + 1e5)) as RANK
    from T_DIMENSION_VALUES DIM
    inner join T_TEXT_ITEMS TXT
      on TXT.ITM_ID = DIM.ITM_ID
      and TXT.TXTT_CODE = 'DESCR'
      and TXT.SEQ_NBR = 1
    inner join T_LANGUAGES LANG
      on LANG.CODE = TXT.LANG_CODE
    left outer join T_USER_LANGUAGE_PREFERENCES ULP
      on ULP.LANG_CODE = TXT.LANG_CODE
      and ULP.USERID = sys_context('PSR', 'USERID'))
  where RANK = 1),
--
Q_LOCATIONS as
 (select ID, NAME
  from
   (select LOC.ID, TXT.TEXT as NAME,
      row_number() over
       (partition by LOC.ID
        order by LANG.ACTIVE_FLAG desc, nvl(ULP.PREF_SEQ, LANG.DISPLAY_SEQ + 1e5)) as RANK
    from T_LOCATIONS LOC
    inner join T_TEXT_ITEMS TXT
      on TXT.ITM_ID = LOC.ITM_ID
      and TXT.TXTT_CODE = 'NAME'
      and TXT.SEQ_NBR = 1
    inner join T_LANGUAGES LANG
      on LANG.CODE = TXT.LANG_CODE
    left outer join T_USER_LANGUAGE_PREFERENCES ULP
      on ULP.LANG_CODE = TXT.LANG_CODE
      and ULP.USERID = sys_context('PSR', 'USERID'))
  where RANK = 1)
--
select cast(RSD.ASR_YEAR as number(4)) as ASR_YEAR, RSD.LOC_ID_ASYLUM_COUNTRY,
  RSD.DIM_ID1 as DIM_ID_RSDTYPE, DIM1.CODE as RSDTYPE_CODE, DIM1.DESCRIPTION as RSDTYPE_DESCRIPTION,
  RSD.DIM_ID2 as DIM_ID_RSDLEVEL, DIM2.CODE as RSDLEVEL_CODE,
  DIM2.DESCRIPTION as RSDLEVEL_DESCRIPTION,
  RSD.LOC_ID_ORIGIN_COUNTRY,
  cast(LOCA1.CHAR_VALUE as varchar2(3)) as ISO_ORIGIN_CODE,
  cast(LOCA2.CHAR_VALUE as varchar2(3)) as UNHCR_ORIGIN_CODE,
  LOC.NAME as LOC_NAME_ORIGIN_COUNTRY,
  RSD.STG_ID_PRIMARY, STG.VERSION_NBR as STG_VERSION_NBR, STG.ITM_ID as STG_ITM_ID,
  RSD.ASYPOP_START_VALUE, RSD.ASYPOP_START_STC_ID, RSD.ASYPOP_START_VERSION_NBR,
  RSD.ASYPOP_START_ITM_ID,
  RSD.ASYPOP_AH_START_VALUE, RSD.ASYPOP_AH_START_STC_ID, RSD.ASYPOP_AH_START_VERSION_NBR,
  RSD.ASYPOP_AH_START_ITM_ID,
  RSD.ASYAPP_VALUE, RSD.ASYAPP_STC_ID, RSD.ASYAPP_VERSION_NBR, RSD.ASYAPP_ITM_ID,
  RSD.ASYREC_CV_VALUE, RSD.ASYREC_CV_STC_ID, RSD.ASYREC_CV_VERSION_NBR, RSD.ASYREC_CV_ITM_ID,
  RSD.ASYREC_CP_VALUE, RSD.ASYREC_CP_STC_ID, RSD.ASYREC_CP_VERSION_NBR, RSD.ASYREC_CP_ITM_ID,
  RSD.ASYREJ_VALUE, RSD.ASYREJ_STC_ID, RSD.ASYREJ_VERSION_NBR, RSD.ASYREJ_ITM_ID,
  RSD.ASYOTHCL_VALUE, RSD.ASYOTHCL_STC_ID, RSD.ASYOTHCL_VERSION_NBR, RSD.ASYOTHCL_ITM_ID,
  RSD.ASYPOP_END_VALUE, RSD.ASYPOP_END_STC_ID, RSD.ASYPOP_END_VERSION_NBR, RSD.ASYPOP_END_ITM_ID,
  RSD.ASYPOP_AH_END_VALUE, RSD.ASYPOP_AH_END_STC_ID, RSD.ASYPOP_AH_END_VERSION_NBR,
  RSD.ASYPOP_AH_END_ITM_ID,
  STG.UPDATE_TIMESTAMP, STG.UPDATE_USERID
from Q_ASR_RSD RSD
inner join Q_DIMENSION_VALUES DIM1
  on DIM1.ID = RSD.DIM_ID1
inner join Q_DIMENSION_VALUES DIM2
  on DIM2.ID = RSD.DIM_ID2
left outer join Q_LOCATIONS LOC
  on LOC.ID = RSD.LOC_ID_ORIGIN_COUNTRY
left outer join T_LOCATION_ATTRIBUTES LOCA1
  on LOCA1.LOC_ID = LOC.ID
  and LOCA1.LOCAT_CODE = 'IS03166A3'
left outer join T_LOCATION_ATTRIBUTES LOCA2
  on LOCA2.LOC_ID = LOC.ID
  and LOCA2.LOCAT_CODE = 'HCRCC'
left outer join T_STATISTIC_GROUPS STG
  on STG.ID = RSD.STG_ID_PRIMARY;
