--
-- ASR_REFUGEES - Refugee population and changes
--
create or replace view ASR_REFUGEES as
with Q_ASR_REFUGEES as
 (select ASR_YEAR, DST_ID, LOC_ID_ASYLUM_COUNTRY, LOC_ID_ORIGIN_COUNTRY, STG_ID_PRIMARY,
    REFPOP_START_VALUE, REFPOP_START_STC_ID, REFPOP_START_VERSION_NBR, REFPOP_START_ITM_ID,
    REFPOP_AH_START_VALUE, REFPOP_AH_START_STC_ID, REFPOP_AH_START_VERSION_NBR,
    REFPOP_AH_START_ITM_ID,
    ARR_GRP_VALUE, ARR_GRP_STC_ID, ARR_GRP_VERSION_NBR, ARR_GRP_ITM_ID,
    ARR_TMP_VALUE, ARR_TMP_STC_ID, ARR_TMP_VERSION_NBR, ARR_TMP_ITM_ID,
    ARR_IND_VALUE, ARR_IND_STC_ID, ARR_IND_VERSION_NBR, ARR_IND_ITM_ID,
    ARR_RESTL_VALUE, ARR_RESTL_STC_ID, ARR_RESTL_VERSION_NBR, ARR_RESTL_ITM_ID,
    BIRTH_VALUE, BIRTH_STC_ID, BIRTH_VERSION_NBR, BIRTH_ITM_ID,
    REFOTHINC_VALUE, REFOTHINC_STC_ID, REFOTHINC_VERSION_NBR, REFOTHINC_ITM_ID,
    VOLREP_VALUE, VOLREP_STC_ID, VOLREP_VERSION_NBR, VOLREP_ITM_ID,
    VOLREP_AH_VALUE, VOLREP_AH_STC_ID, VOLREP_AH_VERSION_NBR, VOLREP_AH_ITM_ID,
    RESTL_VALUE, RESTL_STC_ID, RESTL_VERSION_NBR, RESTL_ITM_ID,
    RESTL_AH_VALUE, RESTL_AH_STC_ID, RESTL_AH_VERSION_NBR, RESTL_AH_ITM_ID,
    CESSATION_VALUE, CESSATION_STC_ID, CESSATION_VERSION_NBR, CESSATION_ITM_ID,
    NATURLZN_VALUE, NATURLZN_STC_ID, NATURLZN_VERSION_NBR, NATURLZN_ITM_ID,
    DEATH_VALUE, DEATH_STC_ID, DEATH_VERSION_NBR, DEATH_ITM_ID,
    REFOTHDEC_VALUE, REFOTHDEC_STC_ID, REFOTHDEC_VERSION_NBR, REFOTHDEC_ITM_ID,
    REFPOP_END_VALUE, REFPOP_END_STC_ID, REFPOP_END_VERSION_NBR, REFPOP_END_ITM_ID,
    REFPOP_AH_END_VALUE, REFPOP_AH_END_STC_ID, REFPOP_AH_END_VERSION_NBR, REFPOP_AH_END_ITM_ID
  from
   (select to_char(extract(year from STC.START_DATE)) as ASR_YEAR, STC.DST_ID,
      STC.LOC_ID_ASYLUM_COUNTRY, STC.LOC_ID_ORIGIN_COUNTRY, STC.STG_ID_PRIMARY,
      replace(STC.STCT_CODE, '-', '_') ||
        case
          when extract(day from STC.END_DATE) = 2 then '_START'
          when extract(day from STC.START_DATE) = 31 then '_END'
        end as COLUMN_NAME,
      STC.VALUE,
      STC.ID as STC_ID,
      STC.VERSION_NBR,
      STC.ITM_ID
    from T_STATISTIC_TYPES_IN_GROUPS STTIG
    inner join T_STATISTICS STC
      on STC.STCT_CODE = STTIG.STCT_CODE
    where STTIG.STTG_CODE = 'REFUGEE')
  pivot
   (sum(VALUE) as VALUE, max(STC_ID) as STC_ID, max(VERSION_NBR) as VERSION_NBR,
      max(ITM_ID) as ITM_ID
    for COLUMN_NAME
    in ('REFPOP_START' as REFPOP_START,
        'REFPOP_AH_START' as REFPOP_AH_START,
        'ARR_GRP' as ARR_GRP,
        'ARR_TMP' as ARR_TMP,
        'ARR_IND' as ARR_IND,
        'ARR_RESTL' as ARR_RESTL,
        'BIRTH' as BIRTH,
        'REFOTHINC' as REFOTHINC,
        'VOLREP' as VOLREP,
        'VOLREP_AH' as VOLREP_AH,
        'RESTL' as RESTL,
        'RESTL_AH' as RESTL_AH,
        'CESSATION' as CESSATION,
        'NATURLZN' as NATURLZN,
        'DEATH' as DEATH,
        'REFOTHDEC' as REFOTHDEC,
        'REFPOP_END' as REFPOP_END,
        'REFPOP_AH_END' as REFPOP_AH_END))),
--
Q_LOCATIONS as
 (select ID, NAME
  from
   (select LOC.ID, TXT.TEXT as NAME,
      row_number() over
       (partition by LOC.ID
        order by LANG.ACTIVE_FLAG desc, nvl(ULP.PREF_SEQ, LANG.DISPLAY_SEQ + 1e5)) as RANK
    from T_LOCATIONS LOC
    inner join T_TEXT_ITEMS TXT
      on TXT.ITM_ID = LOC.ITM_ID
      and TXT.TXTT_CODE = 'NAME'
      and TXT.SEQ_NBR = 1
    inner join T_LANGUAGES LANG
      on LANG.CODE = TXT.LANG_CODE
    left outer join T_USER_LANGUAGE_PREFERENCES ULP
      on ULP.LANG_CODE = TXT.LANG_CODE
      and ULP.USERID = sys_context('PSR', 'USERID'))
  where RANK = 1),
--
Q_DISPLACEMENT_STATUSES as
 (select ID, DESCRIPTION, CODE
  from
   (select DST.ID, TXT.TEXT DESCRIPTION, DST.CODE,
      row_number() over
       (partition by DST.ID
        order by LANG.ACTIVE_FLAG desc, nvl(ULP.PREF_SEQ, LANG.DISPLAY_SEQ + 1e5)) as RANK
    from T_DISPLACEMENT_STATUSES DST
    inner join T_TEXT_ITEMS TXT
      on TXT.ITM_ID = DST.ITM_ID
      and TXT.TXTT_CODE = 'DESCR'
      and TXT.SEQ_NBR = 1
    inner join T_LANGUAGES LANG
      on LANG.CODE = TXT.LANG_CODE
    left outer join T_USER_LANGUAGE_PREFERENCES ULP
      on ULP.LANG_CODE = TXT.LANG_CODE
      and ULP.USERID = sys_context('PSR', 'USERID'))
  where RANK = 1)
--
select cast(REF.ASR_YEAR as number(4)) as ASR_YEAR, REF.LOC_ID_ASYLUM_COUNTRY,
  REF.LOC_ID_ORIGIN_COUNTRY, LOC.NAME as LOC_NAME_ORIGIN_COUNTRY,
  REF.DST_ID, DST.DESCRIPTION as DST_DESCRIPTION, DST.CODE as DST_CODE,
  REF.STG_ID_PRIMARY, STG.VERSION_NBR as STG_VERSION_NBR, STG.ITM_ID as STG_ITM_ID,
  cast(STGA1.CHAR_VALUE as varchar2(10)) as SOURCE, STGA1.VERSION_NBR as STGA_VERSION_NBR_SOURCE,
  STGA1.ITM_ID as STGA_ITM_ID_SOURCE,
  cast(STGA2.CHAR_VALUE as varchar2(10)) as BASIS, STGA2.VERSION_NBR as STGA_VERSION_NBR_BASIS,
  STGA2.ITM_ID as STGA_ITM_ID_BASIS,
  REF.REFPOP_START_VALUE, REF.REFPOP_START_STC_ID, REF.REFPOP_START_VERSION_NBR,
  REF.REFPOP_START_ITM_ID,
  REF.REFPOP_AH_START_VALUE, REF.REFPOP_AH_START_STC_ID, REF.REFPOP_AH_START_VERSION_NBR,
  REF.REFPOP_AH_START_ITM_ID,
  REF.ARR_GRP_VALUE, REF.ARR_GRP_STC_ID, REF.ARR_GRP_VERSION_NBR, REF.ARR_GRP_ITM_ID,
  REF.ARR_TMP_VALUE, REF.ARR_TMP_STC_ID, REF.ARR_TMP_VERSION_NBR, REF.ARR_TMP_ITM_ID,
  REF.ARR_IND_VALUE, REF.ARR_IND_STC_ID, REF.ARR_IND_VERSION_NBR, REF.ARR_IND_ITM_ID,
  REF.ARR_RESTL_VALUE, REF.ARR_RESTL_STC_ID, REF.ARR_RESTL_VERSION_NBR, REF.ARR_RESTL_ITM_ID,
  REF.BIRTH_VALUE, REF.BIRTH_STC_ID, REF.BIRTH_VERSION_NBR, REF.BIRTH_ITM_ID,
  REF.REFOTHINC_VALUE, REF.REFOTHINC_STC_ID, REF.REFOTHINC_VERSION_NBR, REF.REFOTHINC_ITM_ID,
  REF.VOLREP_VALUE, REF.VOLREP_STC_ID, REF.VOLREP_VERSION_NBR, REF.VOLREP_ITM_ID,
  REF.VOLREP_AH_VALUE, REF.VOLREP_AH_STC_ID, REF.VOLREP_AH_VERSION_NBR, REF.VOLREP_AH_ITM_ID,
  REF.RESTL_VALUE, REF.RESTL_STC_ID, REF.RESTL_VERSION_NBR, REF.RESTL_ITM_ID,
  REF.RESTL_AH_VALUE, REF.RESTL_AH_STC_ID, REF.RESTL_AH_VERSION_NBR, REF.RESTL_AH_ITM_ID,
  REF.CESSATION_VALUE, REF.CESSATION_STC_ID, REF.CESSATION_VERSION_NBR, REF.CESSATION_ITM_ID,
  REF.NATURLZN_VALUE, REF.NATURLZN_STC_ID, REF.NATURLZN_VERSION_NBR, REF.NATURLZN_ITM_ID,
  REF.DEATH_VALUE, REF.DEATH_STC_ID, REF.DEATH_VERSION_NBR, REF.DEATH_ITM_ID,
  REF.REFOTHDEC_VALUE, REF.REFOTHDEC_STC_ID, REF.REFOTHDEC_VERSION_NBR, REF.REFOTHDEC_ITM_ID,
  REF.REFPOP_END_VALUE, REF.REFPOP_END_STC_ID, REF.REFPOP_END_VERSION_NBR, REF.REFPOP_END_ITM_ID,
  REF.REFPOP_AH_END_VALUE, REF.REFPOP_AH_END_STC_ID, REF.REFPOP_AH_END_VERSION_NBR,
  REF.REFPOP_AH_END_ITM_ID,
  STG.UPDATE_TIMESTAMP, STG.UPDATE_USERID
from Q_ASR_REFUGEES REF
left outer join Q_LOCATIONS LOC
  on LOC.ID = REF.LOC_ID_ORIGIN_COUNTRY
inner join Q_DISPLACEMENT_STATUSES DST
  on DST.ID = REF.DST_ID
left outer join T_STATISTIC_GROUPS STG
  on STG.ID = REF.STG_ID_PRIMARY
left outer join T_STC_GROUP_ATTRIBUTES STGA1
  on STGA1.STG_ID = STG.ID
  and STGA1.STGAT_CODE = 'SOURCE'
left outer join T_STC_GROUP_ATTRIBUTES STGA2
  on STGA2.STG_ID = STG.ID
  and STGA2.STGAT_CODE = 'BASIS';
