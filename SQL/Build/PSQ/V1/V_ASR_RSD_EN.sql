CREATE or replace  VIEW
    V_ASR_RSD_EN ( ASR_YEAR, LOC_ID_ASYLUM_COUNTRY, COU_CODE_ASYLUM, COU_NAME_ASYLUM_EN, LOC_ID_ORIGIN_COUNTRY, COU_CODE_ORIGIN, COU_NAME_ORIGIN_EN, RSD_PROC_TYPE_CODE, RSD_PROC_TYPE_DESCRIPTION_EN, RSD_PROC_LEVEL_CODE, RSD_PROC_LEVEL_DESCRIPTION_EN, ASYPOP_START_VALUE, ASYPOP_START_REDACTED_FLAG, ASYPOP_AH_START_VALUE, ASYPOP_AH_START_REDACTED_FLAG, ASYAPP_VALUE, ASYAPP_REDACTED_FLAG, ASYREC_CV_VALUE, ASYREC_CV_REDACTED_FLAG, ASYREC_CP_VALUE, ASYREC_CP_REDACTED_FLAG, ASYREJ_VALUE, ASYREJ_REDACTED_FLAG, ASYOTHCL_VALUE, ASYOTHCL_REDACTED_FLAG, ASYPOP_END_VALUE, ASYPOP_END_REDACTED_FLAG, ASYPOP_AH_END_VALUE, ASYPOP_AH_END_REDACTED_FLAG ) AS
WITH
    Q_RSD AS
    (
        SELECT
            ASR_YEAR,
            LOC_ID_ASYLUM_COUNTRY,
            LOC_ID_ORIGIN_COUNTRY,
            DIM_ID1,
            DIM_ID2,
            ASYPOP_START_VALUE,
            ASYPOP_AH_START_VALUE,
            ASYAPP_VALUE,
            ASYREC_CV_VALUE,
            ASYREC_CP_VALUE,
            ASYREJ_VALUE,
            ASYOTHCL_VALUE,
            ASYPOP_END_VALUE,
            ASYPOP_AH_END_VALUE
        FROM
            (
                SELECT
                    extract(YEAR FROM STC.START_DATE) AS ASR_YEAR,
                    STC.LOC_ID_ASYLUM_COUNTRY,
                    STC.LOC_ID_ORIGIN_COUNTRY,
                    STC.DIM_ID1,
                    STC.DIM_ID2,
                    REPLACE(STC.STCT_CODE, '-', '_') ||
                    CASE
                        WHEN extract(DAY FROM STC.END_DATE) = 2
                        THEN '_START'
                        WHEN extract(DAY FROM STC.START_DATE) = 31
                        THEN '_END'
                    END AS DATA_POINT,
                    STC.VALUE
                FROM
                    T_STATISTIC_TYPES_IN_GROUPS STTIG
                INNER JOIN T_STATISTICS STC
                ON
                    STC.STCT_CODE = STTIG.STCT_CODE
                LEFT OUTER JOIN T_AGE_RANGES AGR
                ON
                    AGR.ID = STC.AGR_ID
                WHERE
                    STTIG.STTG_CODE = 'RSD'
            )
            pivot (SUM(VALUE) AS VALUE FOR DATA_POINT IN ('ASYPOP_START' AS ASYPOP_START, 'ASYPOP_AH_START' AS ASYPOP_AH_START, 'ASYAPP' AS ASYAPP, 'ASYREC_CV' AS ASYREC_CV, 'ASYREC_CP' AS ASYREC_CP, 'ASYREJ' AS ASYREJ, 'ASYOTHCL' AS ASYOTHCL, 'ASYPOP_END' AS ASYPOP_END, 'ASYPOP_AH_END' AS ASYPOP_AH_END))
    )
    ,
    --
Q_COUNTRIES_EN AS
    (
        SELECT
            LOC.ID,
            LOCA.CHAR_VALUE AS ISO3166_ALPHA3_CODE,
            nvl(txt1.text, TXT.TEXT)        AS NAME_EN
        FROM
            T_LOCATIONS LOC
        INNER JOIN T_LOCATION_ATTRIBUTES LOCA
        ON
            LOCA.LOC_ID = LOC.ID
        AND LOCA.LOCAT_CODE = 'ISO3166A3'
        INNER JOIN T_TEXT_ITEMS TXT
        ON
            TXT.ITM_ID = LOC.ITM_ID
        AND TXT.TXTT_CODE = 'NAME'
        AND TXT.SEQ_NBR = 1
        AND TXT.LANG_CODE = 'en'
        LEFT OUTER JOIN T_TEXT_ITEMS TXT1
        ON
            TXT1.ITM_ID = loc.ITM_ID
        AND TXT1.TXTT_CODE = 'PSRNAME'
        AND TXT1.SEQ_NBR = 1
        AND TXT1.LANG_CODE = 'en'
    )
    ,
    --
    Q_DIMENSION_VALUES_EN AS
    (
        SELECT
            DIM.ID,
            DIM.CODE,
            TXT.TEXT DESCRIPTION_EN
        FROM
            T_DIMENSION_VALUES DIM
        INNER JOIN T_TEXT_ITEMS TXT
        ON
            TXT.ITM_ID = DIM.ITM_ID
        AND TXT.TXTT_CODE = 'DESCR'
        AND TXT.SEQ_NBR = 1
        AND TXT.LANG_CODE = 'en'
    )
--
SELECT
    RSD.ASR_YEAR,
    RSD.LOC_ID_ASYLUM_COUNTRY,
    COU1.ISO3166_ALPHA3_CODE AS COU_CODE_ASYLUM,
    COU1.NAME_EN             AS COU_NAME_ASYLUM_EN,
    RSD.LOC_ID_ORIGIN_COUNTRY,
    COU2.ISO3166_ALPHA3_CODE AS COU_CODE_ORIGIN,
    CASE
        WHEN COU2.NAME_EN = 'State of Palestine'
        THEN 'Palestinian'
        WHEN COU2.NAME_EN = 'Palestinian Territory, Occupied'
        THEN 'Palestinian'
        ELSE coalesce(COU2.NAME_EN, 'Various/unknown')
    END                 AS COU_NAME_ORIGIN_EN,
    DIM1.CODE           AS RSD_PROC_TYPE_CODE,
    DIM1.DESCRIPTION_EN AS RSD_PROC_TYPE_DESCRIPTION_EN,
    DIM2.CODE           AS RSD_PROC_LEVEL_CODE,
    DIM2.DESCRIPTION_EN AS RSD_PROC_LEVEL_DESCRIPTION_EN,
    CASE
        WHEN ABS(RSD.ASYPOP_START_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYPOP_START_VALUE
    END AS ASYPOP_START_VALUE,
    CASE
        WHEN ABS(RSD.ASYPOP_START_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYPOP_START_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYPOP_AH_START_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYPOP_AH_START_VALUE
    END AS ASYPOP_AH_START_VALUE,
    CASE
        WHEN ABS(RSD.ASYPOP_AH_START_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYPOP_AH_START_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYAPP_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYAPP_VALUE
    END AS ASYAPP_VALUE,
    CASE
        WHEN ABS(RSD.ASYAPP_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYAPP_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYREC_CV_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYREC_CV_VALUE
    END AS ASYREC_CV_VALUE,
    CASE
        WHEN ABS(RSD.ASYREC_CV_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYREC_CV_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYREC_CP_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYREC_CP_VALUE
    END AS ASYREC_CP_VALUE,
    CASE
        WHEN ABS(RSD.ASYREC_CP_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYREC_CP_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYREJ_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYREJ_VALUE
    END AS ASYREJ_VALUE,
    CASE
        WHEN ABS(RSD.ASYREJ_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYREJ_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYOTHCL_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYOTHCL_VALUE
    END AS ASYOTHCL_VALUE,
    CASE
        WHEN ABS(RSD.ASYOTHCL_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYOTHCL_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYPOP_END_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYPOP_END_VALUE
    END AS ASYPOP_END_VALUE,
    CASE
        WHEN ABS(RSD.ASYPOP_END_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYPOP_END_REDACTED_FLAG,
    CASE
        WHEN ABS(RSD.ASYPOP_AH_END_VALUE) >= PAR.NUM_VALUE
         OR ASR_YEAR != '2013'
        THEN RSD.ASYPOP_AH_END_VALUE
    END AS ASYPOP_AH_END_VALUE,
    CASE
        WHEN ABS(RSD.ASYPOP_AH_END_VALUE) < PAR.NUM_VALUE
        AND ASR_YEAR = '2013'
        THEN 1
    END AS ASYPOP_AH_END_REDACTED_FLAG
FROM
    Q_RSD RSD
INNER JOIN Q_COUNTRIES_EN COU1
ON
    COU1.ID = RSD.LOC_ID_ASYLUM_COUNTRY
LEFT OUTER JOIN Q_COUNTRIES_EN COU2
ON
    COU2.ID = RSD.LOC_ID_ORIGIN_COUNTRY
INNER JOIN Q_DIMENSION_VALUES_EN DIM1
ON
    DIM1.ID = RSD.DIM_ID1
INNER JOIN Q_DIMENSION_VALUES_EN DIM2
ON
    DIM2.ID = RSD.DIM_ID2
CROSS JOIN T_SYSTEM_PARAMETERS PAR
WHERE
    PAR.CODE = 'REDACTION LIMIT';